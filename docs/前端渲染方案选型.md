# 前端渲染方案选型

**状态**: 🟡 草稿
**创建日期**: 2026-01-15
**决策类型**: 技术架构决策
**版本**: v0.1

---

## 1. 背景

AI白板 是一个在线白板工具，需要确定前端渲染方案。主要考虑三种方案：
- **CSR** (Client-Side Rendering) - 客户端渲染
- **SSR** (Server-Side Rendering) - 服务端渲染
- **PWA** (Progressive Web App) - 渐进式 Web 应用

---

## 2. 产品特性分析

### 2.1 AI白板的核心特点

| 特性 | 说明 | 对渲染方案的影响 |
|------|------|------------------|
| **工具类应用** | 白板绘图工具，非内容展示 | 不需要 SEO |
| **高交互性** | 大量实时绘图、拖拽、缩放 | 需要流畅的客户端渲染 |
| **Excalidraw 集成** | 基于纯客户端库 | SSR 集成困难 |
| **AI 实时对话** | 右侧聊天面板实时交互 | 需要 WebSocket/SSE |
| **实时协作** | 多人同时编辑（P1） | 需要客户端状态同步 |
| **分享功能** | 生成分享链接 | 分享页面可能需要预览 |
| **离线使用** | 用户可能需要离线绘图 | PWA 是加分项 |

### 2.2 用户使用场景

**主要场景**:
1. 用户直接访问 aibaiban.com 开始绘图
2. 用户通过分享链接查看他人的白板
3. 用户在移动设备上使用（平板、手机）
4. 用户希望离线使用（飞机上、地铁里）

**SEO 需求**: ❌ 低
- 用户不会搜索"画一个流程图"然后找到我们
- 主要通过直接访问、口碑传播、分享链接

**首屏性能需求**: ⚠️ 中等
- 工具类应用，用户可以接受 1-2 秒加载
- 但不能太慢，否则影响体验

---

## 3. 方案对比

### 3.1 CSR (Client-Side Rendering)

#### 工作原理
```
用户访问 → 下载 HTML (空壳) → 下载 JS Bundle →
客户端渲染 → 显示页面 → 用户交互
```

#### 优势 ✅

| 优势 | 说明 | 对 AI白板 的价值 |
|------|------|------------------|
| **开发简单** | 无需考虑服务端渲染逻辑 | ⭐⭐⭐ 快速开发 MVP |
| **部署方便** | 静态文件托管（Vercel/Netlify） | ⭐⭐⭐ 降低运维成本 |
| **交互流畅** | 无页面刷新，SPA 体验 | ⭐⭐⭐ 白板工具必需 |
| **Excalidraw 兼容** | Excalidraw 本身就是 CSR | ⭐⭐⭐ 无集成障碍 |
| **状态管理简单** | 客户端状态管理 | ⭐⭐⭐ 适合复杂交互 |

#### 劣势 ❌

| 劣势 | 说明 | 对 AI白板 的影响 |
|------|------|------------------|
| **SEO 不友好** | 搜索引擎难以抓取 | ⚠️ 影响小（不依赖 SEO） |
| **首屏加载慢** | 需要下载完整 JS | ⚠️ 可优化（代码分割） |
| **分享预览差** | 分享链接无法预览缩略图 | ⚠️ 影响中等 |

#### 技术栈
- **框架**: Vite + React + TypeScript
- **路由**: React Router
- **状态**: Zustand / Redux Toolkit
- **部署**: Vercel / Netlify / Cloudflare Pages

---

### 3.2 SSR (Server-Side Rendering)

#### 工作原理
```
用户访问 → 服务器渲染 HTML → 返回完整 HTML →
客户端 Hydration → 用户交互
```

#### 优势 ✅

| 优势 | 说明 | 对 AI白板 的价值 |
|------|------|------------------|
| **SEO 友好** | 搜索引擎可抓取完整内容 | ⚠️ 价值低（不需要 SEO） |
| **首屏快** | 服务器直接返回 HTML | ⭐⭐ 提升首屏体验 |
| **分享预览好** | 可生成 OG 图片 | ⭐⭐ 分享链接更友好 |

#### 劣势 ❌

| 劣势 | 说明 | 对 AI白板 的影响 |
|------|------|------------------|
| **开发复杂** | 需要考虑服务端/客户端差异 | ❌❌ 增加开发成本 |
| **服务器成本** | 需要 Node.js 服务器 | ❌❌ 增加运维成本 |
| **Excalidraw 集成难** | 纯客户端库，SSR 困难 | ❌❌❌ 技术障碍 |
| **Hydration 问题** | 可能出现闪烁、不一致 | ❌ 影响用户体验 |

#### 技术栈
- **框架**: Next.js (App Router)
- **部署**: Vercel / 自建服务器
- **问题**: Excalidraw 需要 'use client'，失去 SSR 优势

---

### 3.3 PWA (Progressive Web App)

#### 工作原理
```
CSR 基础 + Service Worker + Manifest +
离线缓存 + 桌面安装
```

#### 优势 ✅

| 优势 | 说明 | 对 AI白板 的价值 |
|------|------|------------------|
| **离线使用** | 无网络也能绘图 | ⭐⭐⭐ 重要场景 |
| **桌面安装** | 像原生应用一样 | ⭐⭐ 提升用户粘性 |
| **推送通知** | 协作提醒 | ⭐ 后续功能 |
| **更快加载** | Service Worker 缓存 | ⭐⭐ 提升性能 |

#### 劣势 ❌

| 劣势 | 说明 | 对 AI白板 的影响 |
|------|------|------------------|
| **额外配置** | 需要配置 Service Worker | ⚠️ 增加开发量 |
| **浏览器兼容** | Safari 支持有限 | ⚠️ iOS 用户受影响 |
| **调试复杂** | Service Worker 调试困难 | ⚠️ 开发体验下降 |

#### 技术栈
- **基础**: CSR (Vite + React)
- **PWA 插件**: vite-plugin-pwa
- **离线策略**: Cache First / Network First

---

## 4. 方案评分对比

### 4.1 评分维度

| 维度 | 权重 | CSR | SSR | PWA | 说明 |
|------|------|-----|-----|-----|------|
| **开发速度** | ⭐⭐⭐ | 9 | 5 | 7 | MVP 需要快速迭代 |
| **部署成本** | ⭐⭐⭐ | 9 | 4 | 8 | 初期预算有限 |
| **用户体验** | ⭐⭐⭐ | 8 | 7 | 9 | 流畅度和离线能力 |
| **SEO 需求** | ⭐ | 3 | 9 | 3 | 工具类应用不依赖 SEO |
| **技术兼容** | ⭐⭐⭐ | 10 | 4 | 9 | Excalidraw 兼容性 |
| **可扩展性** | ⭐⭐ | 8 | 8 | 8 | 后续功能扩展 |

### 4.2 加权总分

- **CSR**: (9×3 + 9×3 + 8×3 + 3×1 + 10×3 + 8×2) / 15 = **8.3**
- **SSR**: (5×3 + 4×3 + 7×3 + 9×1 + 4×3 + 8×2) / 15 = **5.9**
- **PWA**: (7×3 + 8×3 + 9×3 + 3×1 + 9×3 + 8×2) / 15 = **8.1**

---

## 5. 推荐方案

### 5.1 MVP 阶段（推荐）⭐

**方案**: **纯 CSR (Vite + React)**

**理由**:
1. ✅ **快速开发**: 专注核心功能，无需考虑 SSR 复杂性
2. ✅ **零服务器成本**: 静态托管，Vercel 免费额度足够
3. ✅ **Excalidraw 完美兼容**: 无需任何适配
4. ✅ **部署简单**: `pnpm build` → 上传静态文件
5. ✅ **SEO 不重要**: 工具类应用不依赖搜索流量

**技术栈**:
```
Vite 5.x
React 18.x
TypeScript 5.x
React Router 6.x
Zustand (状态管理)
Tailwind CSS
@excalidraw/excalidraw
```

**首屏优化方案**:
- 代码分割（React.lazy）
- 路由懒加载
- 图片懒加载
- Gzip/Brotli 压缩
- CDN 加速

---

### 5.2 成长阶段（渐进式）

**方案**: **CSR + PWA**

**时机**: MVP 验证成功后（3-6 个月）

**新增功能**:
- ✅ 离线使用（Service Worker）
- ✅ 桌面安装（Manifest）
- ✅ 推送通知（协作提醒）
- ✅ 后台同步（离线编辑同步）

**实现方式**:
```bash
# 安装 PWA 插件
pnpm add -D vite-plugin-pwa

# vite.config.ts
import { VitePWA } from 'vite-plugin-pwa'

export default {
  plugins: [
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'AI白板',
        short_name: 'AI白板',
        theme_color: '#6366F1',
        icons: [...]
      }
    })
  ]
}
```

---

### 5.3 成熟阶段（混合方案）

**方案**: **Landing Page (SSR) + 白板应用 (CSR)**

**时机**: 需要营销和 SEO 时（1 年后）

**架构**:
```
aibaiban.com (Landing Page - Next.js SSR)
    ↓
app.aibaiban.com (白板应用 - Vite CSR)
```

**或者使用 Next.js App Router**:
```
/                    → SSR (Landing Page)
/about              → SSR
/pricing            → SSR
/app                → CSR ('use client')
/app/board/[id]     → CSR
```

---

## 6. 分享链接的特殊处理

### 6.1 问题

CSR 方案下，分享链接无法生成预览缩略图（OG Image）：

```html
<!-- CSR: 搜索引擎/社交平台看到的 -->
<html>
  <head>
    <title>AI白板</title>
    <!-- 没有具体内容 -->
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
```

### 6.2 解决方案

**方案 A: 预渲染分享页面**（推荐）

使用 Puppeteer 在服务端生成静态 HTML + 缩略图：

```
用户点击"分享"
    ↓
后端生成静态 HTML + PNG 缩略图
    ↓
存储到 CDN
    ↓
分享链接指向静态页面
```

**方案 B: 动态 OG 图片服务**

使用 Vercel OG Image 或自建服务：

```typescript
// /api/og/[boardId].tsx
export default function handler(req) {
  const { boardId } = req.query
  // 生成 OG 图片
  return new ImageResponse(...)
}
```

**方案 C: 客户端预览 + Meta 标签注入**

使用 Cloudflare Workers 注入 meta 标签：

```javascript
// Cloudflare Worker
if (url.includes('/board/')) {
  // 注入动态 meta 标签
  html = html.replace('</head>', `
    <meta property="og:image" content="...">
    </head>
  `)
}
```

---

## 7. 性能优化策略

### 7.1 CSR 首屏优化

**目标**: 首屏加载 < 2 秒

**优化手段**:

1. **代码分割**
```typescript
// 路由懒加载
const BoardPage = lazy(() => import('./pages/Board'))
const AboutPage = lazy(() => import('./pages/About'))
```

2. **资源优化**
- Vite 自动代码分割
- Tree Shaking 移除未使用代码
- Gzip/Brotli 压缩
- 图片使用 WebP 格式

3. **加载策略**
```typescript
// 关键资源优先加载
<link rel="preload" href="/excalidraw.js" as="script">
<link rel="prefetch" href="/ai-chat.js">
```

4. **骨架屏**
```tsx
<Suspense fallback={<BoardSkeleton />}>
  <BoardPage />
</Suspense>
```

### 7.2 运行时性能

- 使用 React.memo 避免不必要渲染
- 虚拟滚动（聊天消息列表）
- Web Worker 处理 AI 响应解析
- IndexedDB 缓存白板数据

---

## 8. 部署方案

### 8.1 MVP 阶段部署

**推荐**: Vercel（免费额度）

**优势**:
- ✅ 自动 CI/CD（Git Push 自动部署）
- ✅ 全球 CDN
- ✅ 自动 HTTPS
- ✅ 预览环境（PR 自动生成预览链接）
- ✅ 零配置

**部署流程**:
```bash
# 1. 连接 GitHub 仓库
# 2. Vercel 自动检测 Vite 项目
# 3. 自动部署

# 或手动部署
pnpm build
vercel --prod
```

### 8.2 备选方案

| 平台 | 优势 | 劣势 | 成本 |
|------|------|------|------|
| **Netlify** | 类似 Vercel | 构建时间限制 | 免费 |
| **Cloudflare Pages** | 无限带宽 | 构建较慢 | 免费 |
| **GitHub Pages** | 简单 | 无服务端功能 | 免费 |
| **自建服务器** | 完全控制 | 运维成本高 | $5-20/月 |

---

## 9. 决策建议

### 9.1 立即执行（MVP）

✅ **采用纯 CSR 方案**

**行动清单**:
- [ ] 使用 Vite + React + TypeScript
- [ ] 配置 React Router
- [ ] 集成 Excalidraw
- [ ] 部署到 Vercel
- [ ] 配置自定义域名

**预期效果**:
- 开发周期: 2-4 周
- 首屏加载: 1.5-2.5 秒
- 部署成本: $0（Vercel 免费）

### 9.2 后续优化（3-6 个月）

⏳ **添加 PWA 支持**

**触发条件**:
- 用户反馈需要离线使用
- 移动端用户占比 > 30%
- 有预算投入 PWA 开发

**行动清单**:
- [ ] 安装 vite-plugin-pwa
- [ ] 配置 Service Worker
- [ ] 设计离线策略
- [ ] 测试离线功能

### 9.3 远期规划（1 年后）

🔮 **考虑混合方案**

**触发条件**:
- 需要 SEO 流量
- 需要 Landing Page 营销
- 分享链接预览很重要

**方案**:
- Landing Page 用 Next.js SSR
- 白板应用保持 CSR
- 或全部迁移到 Next.js App Router

---

## 10. 风险与应对

### 10.1 CSR 的风险

| 风险 | 影响 | 应对方案 |
|------|------|----------|
| **首屏加载慢** | 用户流失 | 代码分割、CDN 加速、骨架屏 |
| **SEO 缺失** | 搜索流量低 | 不依赖 SEO，通过其他渠道获客 |
| **分享预览差** | 分享转化低 | 预渲染分享页面、OG 图片服务 |

### 10.2 技术债务

**如果未来需要 SSR**:
- 迁移成本: 中等（需要重构部分代码）
- 时间成本: 2-4 周
- 风险: Excalidraw 集成需要特殊处理

**降低迁移成本的方法**:
- 使用 Next.js 兼容的代码结构
- 避免使用浏览器特定 API（或做好判断）
- 状态管理使用通用方案（Zustand/Redux）

---

## 11. 总结

### 11.1 最终推荐

🎯 **MVP 阶段: 纯 CSR (Vite + React)**

**核心理由**:
1. AI白板 是工具类应用，不依赖 SEO
2. Excalidraw 是纯客户端库，CSR 兼容性最好
3. 快速开发、零服务器成本、部署简单
4. 首屏性能可通过优化达到可接受水平

**技术栈**:
- Vite 5.x + React 18.x + TypeScript
- React Router 6.x
- Zustand (状态管理)
- Tailwind CSS
- @excalidraw/excalidraw

**部署**: Vercel (免费)

### 11.2 演进路径

```
MVP (0-3 月)          成长期 (3-12 月)        成熟期 (1 年+)
    ↓                      ↓                      ↓
纯 CSR              CSR + PWA            混合方案
(Vite)              (离线能力)           (Landing SSR)
```

---

## 12. 下一步行动

- [ ] 确认采用 CSR 方案
- [ ] 初始化 Vite + React 项目
- [ ] 配置 TypeScript 和 ESLint
- [ ] 集成 Excalidraw
- [ ] 配置 Vercel 部署
- [ ] 实现首屏骨架屏
- [ ] 性能测试和优化

---

## 13. 相关文档

- [产品概述](./产品概述.md)
- [白板页面设计](./白板页面设计.md)
- [技术选型](../docs/技术选型.md)

---

## 14. 更新记录

- 2026-01-15: 创建前端渲染方案选型文档（v0.1）
