# æ„å»ºäº§ç‰©ä¼˜åŒ–æ–¹æ¡ˆ

> åˆ›å»ºæ—¥æœŸï¼š2026-01-26
> ç›®æ ‡ï¼šå‡å°‘åˆå§‹åŠ è½½ä½“ç§¯ï¼Œæå‡é¦–å±æ€§èƒ½

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æ

### æœ€å¤§çš„æ–‡ä»¶ï¼ˆæœªå‹ç¼© / gzippedï¼‰

| æ–‡ä»¶ | å¤§å° | Gzipped | è¯´æ˜ |
|------|------|---------|------|
| subset-shared.chunk | 1.7M | 735KB | Excalidraw å­—ä½“å­é›† |
| flowchart-elk-definition | 1.4M | 444KB | Mermaid æµç¨‹å›¾åº“ |
| percentages | 1.1M | 371KB | å›¾è¡¨æ•°æ®/æ ·å¼ |
| index | 764K | 254KB | ä¸»åº”ç”¨ä»£ç  |
| mindmap-definition | 532K | 169KB | Mermaid æ€ç»´å¯¼å›¾ |
| katex | 260K | 77KB | æ•°å­¦å…¬å¼æ¸²æŸ“ |

### å…¶ä»–é—®é¢˜

- **50+ ä¸ªå›½é™…åŒ–è¯­è¨€åŒ…**ï¼šæ¯ä¸ª 10-40KBï¼Œæ€»è®¡ 1-2MB
- **Mermaid å›¾è¡¨æ¨¡å—**ï¼šæœªæŒ‰éœ€åŠ è½½ï¼Œå…¨éƒ¨æ‰“åŒ…è¿›æ¥
- **æ— ä»£ç åˆ†å‰²ä¼˜åŒ–**ï¼šæ‰€æœ‰ä¾èµ–æ··åœ¨ä¸€èµ·ï¼Œä¸åˆ©äºæµè§ˆå™¨ç¼“å­˜

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰

#### 1.1 æ‰‹åŠ¨ Chunks é…ç½®

å°†ä¸»è¦ä¾èµ–åˆ†ç¦»æˆç‹¬ç«‹çš„ chunksï¼š

```typescript
manualChunks: {
  'react-vendor': ['react', 'react-dom', 'react-router-dom'],
  'antd-base': ['antd'],
  'antd-x': ['@ant-design/x'],
  'antd-icons': ['@ant-design/icons'],
  'excalidraw': ['@excalidraw/excalidraw'],
}
```

**ä¼˜åŠ¿**ï¼š
- React ç­‰åŸºç¡€åº“å•ç‹¬ç¼“å­˜ï¼Œå‡ ä¹ä¸ä¼šæ”¹å˜
- UI ç»„ä»¶åº“å•ç‹¬ç¼“å­˜ï¼Œå‡çº§æ—¶ä¸å½±å“ä¸šåŠ¡ä»£ç 
- Excalidraw å•ç‹¬ç¼“å­˜ï¼Œå¯ä»¥è€ƒè™‘æ‡’åŠ è½½

#### 1.2 è‡ªåŠ¨åˆ†ç»„

```typescript
chunkFileNames: (chunkInfo) => {
  // Mermaid å›¾è¡¨åº“ -> charts/ ç›®å½•
  if (chunkInfo.name.includes('diagram')) {
    return 'charts/[name]-[hash].js'
  }
  // è¯­è¨€åŒ… -> locales/ ç›®å½•
  if (chunkInfo.name.match(/^[a-z]{2}-[A-Z]{2}/)) {
    return 'locales/[name]-[hash].js'
  }
  return 'chunks/[name]-[hash].js'
}
```

**ä¼˜åŠ¿**ï¼š
- å›¾è¡¨åº“æŒ‰éœ€åŠ è½½ï¼ˆç”¨æˆ·ä¸ä½¿ç”¨æ—¶ä¸ä¸‹è½½ï¼‰
- è¯­è¨€åŒ…æŒ‰éœ€åŠ è½½ï¼ˆåªåŠ è½½ç”¨æˆ·è¯­è¨€ï¼‰
- ç›®å½•ç»“æ„æ¸…æ™°ï¼Œä¾¿äº CDN ç¼“å­˜ç­–ç•¥

### 2. è·¯ç”±çº§æ‡’åŠ è½½

**å·²å®ç°** âœ…ï¼š

```tsx
const Whiteboard = lazy(() =>
  import('@/components/Whiteboard').then((m) => ({ default: m.Whiteboard }))
)
```

Excalidraw ç»„ä»¶å·²ç»ä½¿ç”¨ `React.lazy` æ‡’åŠ è½½ï¼Œåªåœ¨è®¿é—®ç™½æ¿æ—¶æ‰åŠ è½½ã€‚

### 3. Terser ä¼˜åŒ–

```typescript
minify: 'terser',
terserOptions: {
  compress: {
    drop_console: true,  // ç§»é™¤ console.log
    drop_debugger: true, // ç§»é™¤ debugger
  },
}
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- å‡å°‘ 5-10% ä½“ç§¯
- æå‡è¿è¡Œæ—¶æ€§èƒ½ï¼ˆå‡å°‘æ—¥å¿—è¾“å‡ºï¼‰

### 4. åŒ…åˆ†æå·¥å…·

å®‰è£… `rollup-plugin-visualizer`ï¼š

```bash
npm install -D rollup-plugin-visualizer
```

è¿è¡Œåˆ†æï¼š

```bash
npm run build:analyze
```

å°†ç”Ÿæˆäº¤äº’å¼å¯è§†åŒ–æŠ¥å‘Š `dist/stats.html`ï¼Œå¯ä»¥çœ‹åˆ°ï¼š
- æ¯ä¸ªåŒ…çš„å®é™…å¤§å°
- å“ªäº›ä¾èµ–å ç”¨æœ€å¤šç©ºé—´
- å“ªäº›ä»£ç å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰ï¼ˆä¼°ç®—ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| åˆå§‹åŠ è½½ JS | ~6MB (gzipped ~2.5MB) |
| é¦–å±æ¸²æŸ“æ—¶é—´ | ~3-5s (3G) |
| å¯äº¤äº’æ—¶é—´ | ~5-8s (3G) |

### ä¼˜åŒ–åï¼ˆä¼°ç®—ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ | æå‡ |
|------|------|------|
| åˆå§‹åŠ è½½ JS | ~2-3MB (gzipped ~800KB) | -60% |
| é¦–å±æ¸²æŸ“æ—¶é—´ | ~1.5-2s (3G) | -50% |
| å¯äº¤äº’æ—¶é—´ | ~2-3s (3G) | -60% |

### åˆ†ç¦»åçš„åŒ…ç»“æ„ï¼ˆä¼°ç®—ï¼‰

| Chunk | å¤§å° (gzipped) | ä½•æ—¶åŠ è½½ |
|-------|---------------|---------|
| react-vendor.js | ~150KB | é¡µé¢åŠ è½½ |
| antd-base.js | ~200KB | é¡µé¢åŠ è½½ |
| antd-x.js | ~50KB | é¡µé¢åŠ è½½ |
| antd-icons.js | ~100KB | é¡µé¢åŠ è½½ |
| excalidraw.js | ~800KB | ç™½æ¿ç»„ä»¶åŠ è½½ |
| charts/*.js | ~500KB | æŒ‰éœ€åŠ è½½ï¼ˆä¸å¸¸ç”¨ï¼‰ |
| locales/*.js | ~1.5MB | æŒ‰éœ€åŠ è½½ï¼ˆä¸éœ€è¦ï¼‰ |
| index.js | ~200KB | é¡µé¢åŠ è½½ |
| **æ€»è®¡ï¼ˆé¦–å±ï¼‰** | **~700KB** | **-72%** |

## ğŸ› ï¸ å®æ–½æ­¥éª¤

### Step 1: å®‰è£…ä¾èµ–

```bash
npm install -D rollup-plugin-visualizer terser
```

### Step 2: ä½¿ç”¨ä¼˜åŒ–é…ç½®

```bash
# å¤‡ä»½å½“å‰é…ç½®
cp vite.config.ts vite.config.old.ts

# ä½¿ç”¨ä¼˜åŒ–é…ç½®
cp vite.config.optimized.ts vite.config.ts
```

### Step 3: æ›´æ–° package.json

```json
{
  "scripts": {
    "build": "tsc && vite build",
    "build:analyze": "tsc && vite build --mode analyze"
  }
}
```

### Step 4: æµ‹è¯•æ„å»º

```bash
# æ­£å¸¸æ„å»º
npm run build

# åˆ†ææ„å»º
npm run build:analyze
```

### Step 5: éªŒè¯æ•ˆæœ

1. æ£€æŸ¥ `../shun-js/packages/aibaiban-server/static/` ç›®å½•ç»“æ„
2. éªŒè¯æ˜¯å¦ç”Ÿæˆäº† `chunks/`, `charts/`, `locales/` ç­‰ç›®å½•
3. æŸ¥çœ‹å„ä¸ª chunk çš„å¤§å°
4. æ‰“å¼€ `dist/stats.html` æŸ¥çœ‹å¯è§†åŒ–åˆ†æ

## ğŸ¯ è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. å¤–éƒ¨åŒ– Excalidrawï¼ˆCDNï¼‰

å¦‚æœ Excalidraw æœ‰ CDN ç‰ˆæœ¬ï¼Œå¯ä»¥å¤–éƒ¨åŒ–ï¼š

```typescript
external: ['@excalidraw/excalidraw'],
```

åœ¨ `index.html` ä¸­å¼•å…¥ï¼š

```html
<script src="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0.18.0"></script>
```

**æ”¶ç›Š**ï¼š-800KB gzipped

### 2. æŒ‰éœ€å¯¼å…¥ Ant Design ç»„ä»¶

å½“å‰æ˜¯å…¨é‡å¯¼å…¥ `antd`ï¼Œå¯ä»¥æ”¹ä¸ºæŒ‰éœ€å¯¼å…¥ï¼š

```typescript
// ä¸æ¨èï¼ˆå…¨é‡å¯¼å…¥ï¼‰
import { Button, Form, Input } from 'antd'

// æ¨èï¼ˆtree shaking ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
import Button from 'antd/es/button'
import Form from 'antd/es/form'
```

ä½† Ant Design 5+ é»˜è®¤æ”¯æŒ tree shakingï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜åŒ–å¯èƒ½ä¸æ˜æ˜¾ã€‚

### 3. ä½¿ç”¨ Brotli å‹ç¼©

åœ¨æœåŠ¡å™¨ç«¯å¯ç”¨ Brotliï¼ˆæ¯” gzip å‹ç¼©ç‡æ›´é«˜ 15-20%ï¼‰ï¼š

```typescript
import viteCompression from 'vite-plugin-compression'

plugins: [
  viteCompression({
    algorithm: 'brotliCompress',
    ext: '.br',
  }),
]
```

### 4. é¢„åŠ è½½å…³é”®èµ„æº

åœ¨ `index.html` ä¸­æ·»åŠ ï¼š

```html
<link rel="preload" href="/react-vendor-{hash}.js" as="script">
<link rel="preload" href="/antd-base-{hash}.js" as="script">
```

### 5. æœåŠ¡ç«¯å¯ç”¨ HTTP/2

HTTP/2 æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œå¤šä¸ªå°æ–‡ä»¶æ¯”ä¸€ä¸ªå¤§æ–‡ä»¶åŠ è½½æ›´å¿«ã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å…¼å®¹æ€§**ï¼šç¡®ä¿ç›®æ ‡æµè§ˆå™¨æ”¯æŒ ES2015
2. **ç¼“å­˜ç­–ç•¥**ï¼šCDN éœ€è¦é…ç½®åˆç†çš„ç¼“å­˜æ—¶é—´
3. **å›é€€æ–¹æ¡ˆ**ï¼šå¦‚æœä¼˜åŒ–åæœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šåˆ° `vite.config.old.ts`
4. **ç›‘æ§**ï¼šä¸Šçº¿åç›‘æ§å®é™…çš„æ€§èƒ½æŒ‡æ ‡

## ğŸ“š å‚è€ƒèµ„æ–™

- [Vite æ„å»ºä¼˜åŒ–](https://vitejs.dev/guide/build.html)
- [Rollup ä»£ç åˆ†å‰²](https://rollupjs.org/guide/en/#code-splitting)
- [Web.dev ä»£ç åˆ†å‰²æŒ‡å—](https://web.dev/code-splitting/)
- [Ant Design Tree Shaking](https://ant.design/docs/react/getting-started#import-on-demand)

---

**æœ€åæ›´æ–°**ï¼š2026-01-26
**ç»´æŠ¤è€…**ï¼šClaude Code
